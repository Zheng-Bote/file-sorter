name: Build & Release
run-name: Build & Release AppImage (Linux) and Windows ZIP by ${{ github.actor }}

# created 2025-12-26 by ZHENG Robert
# Usage:
# To trigger a release build, create a git tag and push it to the repository:
# git add * && git commit -m "release" && git push
# git tag v1.0.0
# git push origin v1.0.0

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ===========================================================================
  # WINDOWS BUILD
  # ===========================================================================
  build-windows:
    name: Windows (MSVC)
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python (für reuse)
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.6.0" # Wähle deine gewünschte Version
          host: "windows"
          arch: "win64_msvc2019_64" # Kompatibel mit MSVC 2022

      - name: Install Tools (Ninja, Reuse, cdxgen)
        run: |
          pip install ninja reuse
          npm install -g @cyclonedx/cdxgen

      - name: Configure CMake
        run: cmake -S . -B build -G "Ninja" -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release

      # CPack erstellt Installer und ZIP
      - name: Package (CPack)
        working-directory: build
        run: cpack -C Release

      # SBOM Generierung
      - name: Generate SBOMs
        shell: bash
        run: |
          # 1. SPDX (JSON) via reuse
          reuse spdx -o FileSorter-Windows.spdx.json

          # 2. CycloneDX (JSON) via cdxgen
          cdxgen -t cmake -o FileSorter-Windows.bom.json

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            build/*.exe
            build/*.zip
            *.json

  # ===========================================================================
  # LINUX BUILD (AppImage)
  # ===========================================================================
  build-linux:
    name: Linux (AppImage)
    runs-on: ubuntu-22.04 # 22.04 ist gut für AppImage Kompatibilität

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python (für reuse)
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      # Linux braucht libfuse2 um AppImages auszuführen (für linuxdeploy)
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 file patchelf build-essential libgl1-mesa-dev

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.6.0"
          host: "linux"

      - name: Install SBOM Tools
        run: |
          pip install reuse
          npm install -g @cyclonedx/cdxgen

      # Dein Skript ausführen
      - name: Create AppImage
        env:
          # Wir überschreiben QMAKE, da die Action es einfach 'qmake' nennt (ohne 6)
          QMAKE: qmake
        run: |
          chmod +x create_appimage_modern.sh
          ./create_appimage_modern.sh

      # SBOM Generierung
      - name: Generate SBOMs
        run: |
          reuse spdx -o FileSorter-Linux.spdx.json
          cdxgen -t cmake -o FileSorter-Linux.bom.json

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            build_appimage/*.AppImage
            *.json

  # ===========================================================================
  # CREATE RELEASE
  # ===========================================================================
  create-release:
    name: Create Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') # Nur laufen lassen, wenn es ein Tag ist

    steps:
      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-artifacts
          path: ./dist

      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-artifacts
          path: ./dist

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*
          generate_release_notes: true
